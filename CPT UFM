{
  "ruleChain": {
    "name": "New CPT UFM",
    "type": "CORE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": true,
    "configuration": null,
    "additionalInfo": {
      "description": ""
    }
  },
  "metadata": {
    "version": 4,
    "firstNodeIndex": 2,
    "nodes": [
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "Save Timeseries",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "defaultTTL": 0,
          "skipLatestPersistence": false,
          "useServerTs": null
        },
        "additionalInfo": {
          "description": null,
          "layoutX": 850,
          "layoutY": 337
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "IEEE754 Hex to Float Converter",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "function swap(val) {\r\n    return ((val & 0xFFFF) << 16) | ((val >> 16) & 0xFFFF);\r\n}\r\n\r\nfunction IEEE754converter(val) {\r\n    var intval = val;\r\n    var fval = 0.0;\r\n    var x;//exponent\r\n    var m;//mantissa\r\n    var s;//sign\r\n    s = (intval & 0x80000000)?-1:1;\r\n    x = ((intval >> 23) & 0xFF);\r\n    m = (intval & 0x7FFFFF);\r\n    switch(x) {\r\n        case 0:\r\n            //zero, do nothing, ignore negative zero and subnormals\r\n            break;\r\n        case 0xFF:\r\n            if (m) fval = NaN;\r\n            else if (s > 0) fval = Number.POSITIVE_INFINITY;\r\n            else fval = Number.NEGATIVE_INFINITY;\r\n            break;\r\n        default:\r\n            x -= 127;\r\n            m += 0x800000;\r\n            fval = s * (m / 8388608.0) * Math.pow(2, x);\r\n            break;\r\n    }\r\n    return fval.toFixed(2);\r\n}\r\n\r\nif ('inflo_a' in msg && msg.inflo_a !== 4290772992 && msg.inflo_a !==0) {\r\n    var pxtag1 = IEEE754converter(msg.inflo_a);\r\n    msg[\"main flowrate 1\"] = parseFloat(pxtag1);\r\n}\r\nif ('teflo1_a' in msg && msg.teflo1_a !== 4290772992 && msg.teflo1_a !==0) {\r\n    var pxtag2 = IEEE754converter(msg.teflo1_a);\r\n      msg[\"supply temp 1\"] = parseFloat(pxtag2); \r\n}\r\nif ('teflo2_a' in msg && msg.teflo2_a !== 4290772992 && msg.teflo2_a !==0) {\r\n    var pxtag3 = IEEE754converter(msg.teflo2_a);\r\n    msg[\"return temp 1\"] = parseFloat(pxtag3);\r\n}\r\n\r\n\r\n\r\nif ('inflo_b' in msg && msg.inflo_b !== 4290772992 && msg.inflo_b !==0) {\r\n    var pxtag1 = IEEE754converter(msg.inflo_b);\r\n    msg[\"main flowrate 2\"] = parseFloat(pxtag1);\r\n}\r\nif ('teflo1_b' in msg && msg.teflo1_b !== 4290772992 && msg.teflo1_b !==0) {\r\n    var pxtag2 = IEEE754converter(msg.teflo1_b);\r\n      msg[\"supply temp 2\"] = parseFloat(pxtag2); \r\n}\r\nif ('teflo2_b' in msg && msg.teflo2_b !== 4290772992 && msg.teflo2_b !==0) {\r\n    var pxtag3 = IEEE754converter(msg.teflo2_b);\r\n    msg[\"return temp 2\"] = parseFloat(pxtag3);\r\n}\r\n\r\n\r\n\r\nreturn {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": null
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 854,
          "layoutY": 189
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbMsgTypeSwitchNode",
        "name": "Message Type Switch",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "version": 0
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 357,
          "layoutY": 150
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Attributes",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 2,
        "configuration": {
          "scope": "CLIENT_SCOPE",
          "notifyDevice": false,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 730,
          "layoutY": 39
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbCreateAlarmNode",
        "name": "Create Inactivity Alarm",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "alarmDetailsBuildJs": "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    delete metadata.prevAlarmDetails;\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "alarmDetailsBuildTbel": "var details = {};\nif (metadata.prevAlarmDetails != null) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    metadata.remove('prevAlarmDetails');\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "useMessageAlarmData": false,
          "overwriteAlarmDetails": false,
          "alarmType": "Inactivity Timeout",
          "severity": "CRITICAL",
          "propagate": false,
          "relationTypes": [],
          "propagateToOwner": false,
          "propagateToOwnerHierarchy": false,
          "propagateToTenant": false,
          "dynamicSeverity": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 715,
          "layoutY": 594
        }
      },
      {
        "type": "org.thingsboard.rule.engine.mail.TbMsgToEmailNode",
        "name": "Inactivity Email",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "fromTemplate": "sqcmboard@gmail.com",
          "toTemplate": "sqcmboard@gmail.com",
          "ccTemplate": "",
          "bccTemplate": "roslee@mimos.my, pannir@mimos.my, pannirk@gmail.com",
          "subjectTemplate": "AEL TB: Device ${deviceName} is Inactive",
          "mailBodyType": "false",
          "bodyTemplate": "AEL: Device ${deviceName} is Inactive"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1020,
          "layoutY": 593
        }
      },
      {
        "type": "org.thingsboard.rule.engine.mail.TbSendEmailNode",
        "name": "Send Gmail",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "useSystemSmtpSettings": true,
          "smtpHost": "localhost",
          "smtpPort": 25,
          "username": null,
          "password": null,
          "smtpProtocol": "smtp",
          "timeout": 10000,
          "enableTls": false,
          "tlsVersion": "TLSv1.2",
          "enableProxy": false,
          "proxyHost": null,
          "proxyPort": null,
          "proxyUser": null,
          "proxyPassword": null
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1380,
          "layoutY": 592
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbClearAlarmNode",
        "name": "Clear Inactivity Alarm",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "TBEL",
          "alarmDetailsBuildJs": "var details = {};\nif (metadata.prevAlarmDetails) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    delete metadata.prevAlarmDetails;\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "alarmDetailsBuildTbel": "var details = {};\nif (metadata.prevAlarmDetails != null) {\n    details = JSON.parse(metadata.prevAlarmDetails);\n    //remove prevAlarmDetails from metadata\n    metadata.remove('prevAlarmDetails');\n    //now metadata is the same as it comes IN this rule node\n}\n\n\nreturn details;",
          "alarmType": "Inactivity Timeout"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 628,
          "layoutY": 698
        }
      },
      {
        "type": "org.thingsboard.rule.engine.mail.TbMsgToEmailNode",
        "name": "Activity Email",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "fromTemplate": "sqcmboard@gmail.com",
          "toTemplate": "sqcmboard@gmail.com",
          "ccTemplate": "",
          "bccTemplate": "roslee@mimos.my, pannir@mimos.my, pannirk@gmail.com",
          "subjectTemplate": "AEL TB: Device ${deviceName} is Active",
          "mailBodyType": "false",
          "bodyTemplate": "AEL: Device ${deviceName} is Active"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 943,
          "layoutY": 701
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Is Initial Attributes?",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "if(typeof msg.Init !== undefined) {\n    return msg.Init > 0;\n}\n\nreturn false;",
          "tbelScript": "return msg.temperature > 20;"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1041,
          "layoutY": 41
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Set Timestamp",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "var today = new Date();\nvar gmtTime = today.getTime();\nvar localOffset = (-1) * today.getTimezoneOffset() * 60000;\nvar localTime = Math.round(new Date(gmtTime+localOffset).getTime() / 1000);\n\nreturn {msg: {\"setTimestamp\": localTime}, metadata: metadata, msgType: msgType};",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1360,
          "layoutY": 42
        }
      },
      {
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "Save Shared Attributes",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 2,
        "configuration": {
          "scope": "SHARED_SCOPE",
          "notifyDevice": true,
          "sendAttributesUpdatedNotification": false,
          "updateAttributesOnlyOnValueChange": false
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1674,
          "layoutY": 44
        }
      },
      {
        "type": "org.thingsboard.rule.engine.action.TbLogNode",
        "name": "Log RPC From Device",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
          "tbelScript": "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 857,
          "layoutY": 474
        }
      },
      {
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "Device RPC Request",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "if(typeof msg[\"method\"] !== 'undefined') {\n    if(msg[\"method\"] === \"getTime\") {\n        var today = new Date();\n        var gmtTime = today.getTime();\n        var localOffset = (-1)*today.getTimezoneOffset()*60000;\n        var localTime = Math.round(new Date(gmtTime+localOffset).getTime()/1000);\n        msg.method = \"setTime\";\n        msg.params = localTime;\n        msgType = \"RPC Message\";\n    }\n}\n\nreturn {msg: msg, metadata: metadata, msgType: msgType};",
          "tbelScript": "return {msg: msg, metadata: metadata, msgType: msgType};"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1190,
          "layoutY": 471
        }
      },
      {
        "type": "org.thingsboard.rule.engine.filter.TbJsFilterNode",
        "name": "Is RPC Message?",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "scriptLang": "JS",
          "jsScript": "return msgType == \"RPC Message\";",
          "tbelScript": "return msg.temperature > 20;"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1512,
          "layoutY": 474
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rpc.TbSendRPCReplyNode",
        "name": "Device RPC Response",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 0,
        "configuration": {
          "serviceIdMetaDataAttribute": "serviceId",
          "sessionIdMetaDataAttribute": "sessionId",
          "requestIdMetaDataAttribute": "requestId"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1740,
          "layoutY": 561
        }
      },
      {
        "type": "org.thingsboard.rule.engine.rest.TbRestApiCallNode",
        "name": "Send to cranes",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 3,
        "configuration": {
          "restEndpointUrlPattern": "https://cranes.asia/api/v1/${deviceName}/telemetry",
          "requestMethod": "POST",
          "useSimpleClientHttpFactory": false,
          "parseToPlainText": null,
          "ignoreRequestBody": false,
          "enableProxy": false,
          "useSystemProxyProperties": false,
          "proxyScheme": null,
          "proxyHost": null,
          "proxyPort": 0,
          "proxyUser": null,
          "proxyPassword": null,
          "readTimeoutMs": 0,
          "maxParallelRequestsCount": 0,
          "headers": {
            "Content-Type": "application/json"
          },
          "credentials": {
            "type": "anonymous"
          },
          "maxInMemoryBufferSizeInKb": 256
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 1126,
          "layoutY": 331
        }
      },
      {
        "type": "org.thingsboard.rule.engine.flow.TbRuleChainInputNode",
        "name": "Device Inactivity Alarm",
        "debugMode": false,
        "singletonMode": false,
        "queueName": null,
        "configurationVersion": 1,
        "configuration": {
          "forwardMsgToDefaultRuleChain": false,
          "ruleChainId": "8a161e80-56ff-11f0-8f5a-cd44175de775"
        },
        "additionalInfo": {
          "description": "",
          "layoutX": 330,
          "layoutY": 294
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 16,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 0,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 1,
        "type": "Post telemetry"
      },
      {
        "fromIndex": 2,
        "toIndex": 3,
        "type": "Post attributes"
      },
      {
        "fromIndex": 2,
        "toIndex": 4,
        "type": "Inactivity Event"
      },
      {
        "fromIndex": 2,
        "toIndex": 7,
        "type": "Activity Event"
      },
      {
        "fromIndex": 2,
        "toIndex": 12,
        "type": "RPC Request from Device"
      },
      {
        "fromIndex": 2,
        "toIndex": 17,
        "type": "Activity Event"
      },
      {
        "fromIndex": 2,
        "toIndex": 17,
        "type": "Inactivity Event"
      },
      {
        "fromIndex": 3,
        "toIndex": 9,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 5,
        "type": "Created"
      },
      {
        "fromIndex": 5,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 7,
        "toIndex": 8,
        "type": "Cleared"
      },
      {
        "fromIndex": 8,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 10,
        "type": "True"
      },
      {
        "fromIndex": 10,
        "toIndex": 11,
        "type": "Success"
      },
      {
        "fromIndex": 12,
        "toIndex": 13,
        "type": "Success"
      },
      {
        "fromIndex": 13,
        "toIndex": 14,
        "type": "Success"
      },
      {
        "fromIndex": 14,
        "toIndex": 15,
        "type": "True"
      }
    ],
    "ruleChainConnections": null
  }
}
